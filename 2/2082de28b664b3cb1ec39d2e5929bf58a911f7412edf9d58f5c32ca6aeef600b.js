!function(e){"use strict";function t(e){this.id=++i,r.Traffic&&r.Traffic();var t={type:"mp3",bitRate:16,sampleRate:16e3,onProcess:n};for(var a in e)t[a]=e[a];this.set=t,this._S=9}var n=function(){},r=function(e){return new t(e)};r.IsOpen=function(){var e=r.Stream;if(e){var t=e.getTracks&&e.getTracks()||e.audioTracks||[],n=t[0];if(n){var a=n.readyState;return"live"==a||a==n.LIVE}}return!1},r.BufferSize=4096,r.Destroy=function(){for(var e in o("Recorder Destroy"),a)a[e]()};var a={};r.BindDestroy=function(e,t){a[e]=t},r.Support=function(){var t=e.AudioContext;if(t||(t=e.webkitAudioContext),!t)return!1;var n=navigator.mediaDevices||{};return n.getUserMedia||(n=navigator).getUserMedia||(n.getUserMedia=n.webkitGetUserMedia||n.mozGetUserMedia||n.msGetUserMedia),!!n.getUserMedia&&(r.Scope=n,r.Ctx&&"closed"!=r.Ctx.state||(r.Ctx=new t,r.BindDestroy("Ctx",function(){})),!0)},r.SampleData=function(e,t,n,r,a){r||(r={});var o=r.index||0,i=r.offset||0,s=r.frameNext||[];a||(a={});var c=a.frameSize||1;a.frameType&&(c="mp3"==a.frameType?1152:1);for(var f=0,u=o;u<e.length;u++)f+=e[u].length;f=Math.max(0,f-Math.floor(i));var l=t/n;l>1?f=Math.floor(f/l):(l=1,n=t),f+=s.length;for(var v=new Int16Array(f),p=0,u=0;u<s.length;u++)v[p]=s[u],p++;for(var m=e.length;m>o;o++){for(var h=e[o],u=i,d=h.length;d>u;){var g=Math.floor(u),S=Math.ceil(u),_=u-g,y=h[g],I=d>S?h[S]:(e[o+1]||[y])[0]||0;v[p]=y+(I-y)*_,p++,u+=l}i=u-d}s=null;var M=v.length%c;if(M>0){var x=2*(v.length-M);s=new Int16Array(v.buffer.slice(x)),v=new Int16Array(v.buffer.slice(0,x))}return{index:o,offset:i,frameNext:s,sampleRate:n,data:v}},r.PowerLevel=function(e,t){var n=e/t||0;return 1251>n?Math.round(n/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log(n/1e4)/Math.log(10)))))};var o=function(e,t){var n=new Date,r=("0"+n.getMinutes()).substr(-2)+":"+("0"+n.getSeconds()).substr(-2)+"."+("00"+n.getMilliseconds()).substr(-3),a=["["+r+" Recorder]"+e],o=arguments,i=2,s=console.log;for("number"==typeof t?s=1==t?console.error:3==t?console.warn:s:i=1;i<o.length;i++)a.push(o[i]);s.apply(console,a)};r.CLog=o;var i=0;r.Sync={O:9,C:9},r.prototype=t.prototype={open:function(t,a){var i=this;t=t||n;var s=function(e,t){o("录音open失败："+e+",isUserNotAllow:"+(t=!!t),1),a&&a(e,t)},c=function(){o("open成功"),t(),i._SO=0},f=function(t,n){try{e.top.a}catch(t){return void s('无权录音(跨域，请尝试给iframe添加麦克风访问策略，如allow="camera;microphone")')}/Permission|Allow/i.test(t)?s("用户拒绝了录音权限",!0):s(!1===e.isSecureContext?"无权录音(需https)":/Found/i.test(t)?n+"，无可用麦克风":n)},u=r.Sync,l=++u.O,v=u.C;i._O=i._O_=l,i._SO=i._S;var p=function(){if(v!=u.C||!i._O){var e="open被取消";return l==u.O?i.close():e="open被中断",s(e),!0}};if(r.IsOpen())c();else if(r.Support()){var m=i.envCheck({envName:"H5",canProcess:!0});if(m)s("不能录音："+m);else{var h=function(e){(r.Stream=e)._call={},p()||setTimeout(function(){p()||(r.IsOpen()?(function(){var e=r.Ctx,t=r.Stream,n=t._m=e.createMediaStreamSource(t),a=t._p=(e.createScriptProcessor||e.createJavaScriptNode).call(e,r.BufferSize,1,1);n.connect(a),a.connect(e.destination);var o=t._call;a.onaudioprocess=function(e){for(var t in o){for(var n=e.inputBuffer.getChannelData(0),r=n.length,a=new Int16Array(r),i=0,s=0;r>s;s++){var c=Math.max(-1,Math.min(1,n[s]));c=0>c?32768*c:32767*c,a[s]=c,i+=Math.abs(c)}for(var f in o)o[f](a,i);return}}}(),c()):s("录音功能无效：无音频流"))},100)},d=function(e){var t=e.name||e.message||e.code+":"+e;o("请求录音权限错误",1,e),f(t,"无法录音："+t)},g=r.Scope.getUserMedia({audio:!0},h,d);g&&g.then&&g.then(h)[t&&"catch"](d)}}else f("","此浏览器不支持录音")},close:function(e){e=e||n,this._stop();var t=r.Sync;if(this._O=0,this._O_!=t.O)return o("close被忽略",3),void e();t.C++;var a,i=r.Stream;if(i){(a=r.Stream)._m&&(a._m.disconnect(),a._p.disconnect(),a._p.onaudioprocess=a._p=a._m=null);for(var s=i.getTracks&&i.getTracks()||i.audioTracks||[],c=0;c<s.length;c++){var f=s[c];f.stop&&f.stop()}i.stop&&i.stop()}r.Stream=0,o("close"),e()},mock:function(e,t){var n=this;return n._stop(),n.isMock=1,n.mockEnvInfo=null,n.buffers=[e],n.recSize=e.length,n.srcSampleRate=t,n},envCheck:function(e){var t,n=this.set;return t||(this[n.type+"_envCheck"]?t=this[n.type+"_envCheck"](e,n):n.takeoffEncodeChunk&&(t=n.type+"类型不支持设置takeoffEncodeChunk")),t||""},envStart:function(e,t){var n=this,r=n.set;if(n.isMock=e?1:0,n.mockEnvInfo=e,n.buffers=[],n.recSize=0,n.envInLast=0,n.envInFirst=0,n.envInFix=0,n.envInFixTs=[],r.sampleRate=Math.min(t,r.sampleRate),n.srcSampleRate=t,n.engineCtx=0,n[r.type+"_start"]){var a=n.engineCtx=n[r.type+"_start"](r);a&&(a.pcmDatas=[],a.pcmSize=0)}},envResume:function(){this.envInFixTs=[]},envIn:function(e,t){var n=this,a=n.set,i=n.engineCtx,s=n.srcSampleRate,c=e.length,f=r.PowerLevel(t,c),u=n.buffers,l=u.length;u.push(e);var v=u,p=l,m=Date.now(),h=Math.round(c/s*1e3);n.envInLast=m,1==n.buffers.length&&(n.envInFirst=m-h);var d=n.envInFixTs;d.splice(0,0,{t:m,d:h});for(var g=m,S=0,_=0;_<d.length;_++){var y=d[_];if(3e3<m-y.t){d.length=_;break}g=y.t,S+=y.d}var I=d[1],M=m-g;if(M-S>M/3&&(I&&M>1e3||6<=d.length)){var x=m-I.t-h;if(x>h/5){var k=!a.disableEnvInFix;if(o("["+m+"]"+(k?"":"未")+"补偿"+x+"ms",3),n.envInFix+=x,k){var C=new Int16Array(x*s/1e3);c+=C.length,u.push(C)}}}var R=n.recSize,w=c,b=R+w;if(n.recSize=b,i){var T=r.SampleData(u,s,a.sampleRate,i.chunkInfo);i.chunkInfo=T,b=(R=i.pcmSize)+(w=T.data.length),i.pcmSize=b,u=i.pcmDatas,l=u.length,u.push(T.data),s=T.sampleRate}var z=Math.round(b/s*1e3),D=u.length,O=v.length,U=function(){for(var e=F?0:-w,t=null==u[0],r=l;D>r;r++){var o=u[r];null==o?t=1:(e+=o.length,i&&o.length&&n[a.type+"_encode"](i,o))}if(t&&i)for(r=p,v[0]&&(r=0);O>r;r++)v[r]=null;t&&(e=F?w:0,u[0]=null),i?i.pcmSize+=e:n.recSize+=e},F=a.onProcess(u,f,z,s,l,U);if(!0===F){var A=0;for(_=l;D>_;_++)null==u[_]?A=1:u[_]=new Int16Array(0);A?o("未进入异步前不能清除buffers",3):i?i.pcmSize-=w:n.recSize-=w}else U()},start:function(){if(r.IsOpen()){o("开始录音");var e=this,t=(e.set,r.Ctx);if(e._stop(),e.state=0,e.envStart(null,t.sampleRate),e._SO&&e._SO+1!=e._S)o("start被中断",3);else{e._SO=0;var n=function(){e.state=1,e.resume()};"suspended"==t.state?t.resume().then(function(){}):n()}}else o("未open",1)},pause:function(){this.state&&(this.state=2,o("pause"),delete r.Stream._call[this.id])},resume:function(){var e=this;e.state&&(e.state=1,o("resume"),e.envResume(),r.Stream._call[e.id]=function(){})},_stop:function(e){var t=this,n=t.set;t.isMock||t._S++,t.state&&(t.pause(),t.state=0),!e&&t[n.type+"_stop"]&&(t[n.type+"_stop"](t.engineCtx),t.engineCtx=0)},stop:function(e,t,n){var a,i=this,s=i.set;o("Stop "+(i.envInLast?i.envInLast-i.envInFirst+"ms 补"+i.envInFix+"ms":"-"));var c=function(){}